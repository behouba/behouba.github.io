<!doctype html><html lang=en><head><title>Coordinated checkpointing with criu-coordinator and Podman :: Behouba Manassé K</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="During Google Summer of Code 2025, I had the opportunity to work with the CRIU (Checkpoint/Restore In Userspace) project on the problem of coordinated checkpointing of distributed applications.
CRIU can save the complete state of a running application to disk and later restore it. This works well for a single process, but distributed applications involve multiple processes (sometimes across different nodes) that interact via network connections. Capturing and restoring their state in a consistent way requires coordination.
"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://behouba.github.io/2025/09/coordinated-checkpointing-with-criu-coordinator-and-podman/><meta property="og:locale" content="en"><meta property="og:title" content="Coordinated checkpointing with criu-coordinator and Podman :: Behouba Manassé K"><meta property="og:description" content="During Google Summer of Code 2025, I had the opportunity to work with the CRIU (Checkpoint/Restore In Userspace) project on the problem of coordinated checkpointing of distributed applications.
CRIU can save the complete state of a running application to disk and later restore it. This works well for a single process, but distributed applications involve multiple processes (sometimes across different nodes) that interact via network connections. Capturing and restoring their state in a consistent way requires coordination.
"><meta property="og:type" content="article"><meta property="article:published_time" content="2025-09-20 00:00:00 +0000 UTC"><meta property="article:modified_time" content="2025-09-20 16:49:20 -0500"><meta property="article:author" content="Kouame Behouba Manassé"><meta property="og:url" content="https://behouba.github.io/2025/09/coordinated-checkpointing-with-criu-coordinator-and-podman/"><meta property="og:site_name" content="Behouba Manassé K"><meta property="og:image" content="/images/favicons/favicon.ico"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9LNJ1NC1E"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-Y9LNJ1NC1E")}</script><link rel="shortcut icon" href=https://behouba.github.io/images/favicons/favicon.ico><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,300;0,400;0,500;1,300;1,400;1,500&family=Roboto+Slab:wght@300;400;500&family=Ubuntu+Mono:ital@0;1&display=swap" rel=stylesheet><link href=https://behouba.github.io/2025/09/coordinated-checkpointing-with-criu-coordinator-and-podman/ rel=alternate type=application/rss+xml title="Behouba Manassé K"><link rel=stylesheet href=https://behouba.github.io/styles.8823cf9ff9f4a0a8b9abc618182e4c23b78c56a848f9fdca41b9a6c4a2fe5c3b.css integrity="sha256-iCPPn/n0oKi5q8YYGC5MI7eMVqhI+f3KQbmmxKL+XDs="></head><body><div class=theme-container><div class="container center"><header class=site-header><nav class=navbar><div class=navbar__first><ul class="navbar__list borders"><li><a href=https://behouba.github.io/>Home</a></li><li><button class="theme-toggle transparent"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></button></li></ul></div><div class=navbar__separator></div><div class=navbar__last><ul class="navbar__list borders menu--desktop"></ul><ul class="menu menu--mobile"><li class=menu-trigger>===</li><li><ul class=menu-dropdown></ul></li></ul></div></nav><nav class=breadcrumbs aria-label=breadcrumbs><a href=https://behouba.github.io/>Home</a>&nbsp;/&nbsp;
<a href=https://behouba.github.io/posts/>Posts</a></nav></header><main class=site-main><article class=post><header class=post-header><h1 class=post-title><a href=https://behouba.github.io/2025/09/coordinated-checkpointing-with-criu-coordinator-and-podman/>Coordinated checkpointing with criu-coordinator and Podman</a></h1><div class=post-meta><time pubdate datetime="2025-09-20 00:00:00 UTC">Published on
2025-09-20 00:00:00 UTC
</time><span>by Kouame Behouba Manassé</span>
<time pubdate datetime="2025-09-20 16:49:20 -0500">last modified 2025-09-20 16:49:20 -0500.</time></div><p class=post-tags>Tags:&nbsp;#<a href=https://behouba.github.io/tags/criu/>CRIU</a>&nbsp;#<a href=https://behouba.github.io/tags/cybersecurity/>Cybersecurity</a>&nbsp;#<a href=https://behouba.github.io/tags/container/>Container</a>&nbsp;#<a href=https://behouba.github.io/tags/docker/>Docker</a>&nbsp;#<a href=https://behouba.github.io/tags/podman/>Podman</a>&nbsp;#<a href=https://behouba.github.io/tags/checkpoint/restore/>Checkpoint/Restore</a>&nbsp;#<a href=https://behouba.github.io/tags/rust/>Rust</a>&nbsp;#<a href=https://behouba.github.io/tags/linux/>Linux</a>&nbsp;</p></header><div class=post-toc><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#install-criu-coordinator>Install criu-coordinator</a></li><li><a href=#build-tcp-client-and-server-images>Build TCP client and server images</a></li><li><a href=#build-the-images>Build the images</a></li><li><a href=#start-the-coordinator-server>Start the coordinator server</a></li><li><a href=#create-a-network-for-containers>Create a network for containers</a></li><li><a href=#run-tcp-client-and-server-containers>Run TCP client and server containers</a></li><li><a href=#configure-criu-coordinator>Configure criu-coordinator</a></li><li><a href=#checkpoint-both-containers>Checkpoint both containers</a></li><li><a href=#clean-up>Clean up</a></li><li><a href=#restore-both-containers>Restore both containers</a></li><li><a href=#resources>Resources</a></li></ul></nav></div><div class=post-content><p>During Google Summer of Code 2025, I had the opportunity to work with the <strong>CRIU (Checkpoint/Restore In Userspace)</strong> project on the problem of <strong>coordinated checkpointing of distributed applications</strong>.</p><p>CRIU can save the complete state of a running application to disk and later restore it. This works well for a <strong>single process</strong>, but distributed applications involve multiple processes (sometimes across different nodes) that interact via <strong>network connections</strong>. Capturing and restoring their state in a consistent way requires coordination.</p><p>That’s where <strong>criu-coordinator</strong> comes in: a lightweight client–server tool that orchestrates CRIU’s checkpoint and restore phases across multiple processes, ensuring they move in lockstep.</p><p>In this post, I’ll walk you through a demo of how to use criu-coordinator with Podman to checkpoint and restore a simple distributed application consisting of a TCP client and server.</p><hr><h2 id=prerequisites>Prerequisites
<a href=#prerequisites class=hanchor arialabel=Anchor></a></h2><ul><li>A Linux operating system</li><li>Podman installed</li><li>CRIU installed</li></ul><h2 id=install-criu-coordinator>Install criu-coordinator
<a href=#install-criu-coordinator class=hanchor arialabel=Anchor></a></h2><p>Start by cloning the criu-coordinator repository and installing it:</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/checkpoint-restore/criu-coordinator.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> criu-coordinator
</span></span><span class=line><span class=cl>sudo make install</span></span></code></pre></div></div><h2 id=build-tcp-client-and-server-images>Build TCP client and server images
<a href=#build-tcp-client-and-server-images class=hanchor arialabel=Anchor></a></h2><p>The demo uses simple TCP client and server programs written in C. You can find them inside the <code>tests/</code> directory of the criu-coordinator repository.</p><p>tcp-server.c:</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>c</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>serve_new_conn</span><span class=p>(</span><span class=kt>int</span> <span class=n>sk</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>counter</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;New connection</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=nf>write</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>counter</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>counter</span><span class=p>)))</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Can&#39;t write socket&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>counter</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>main_srv</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sk</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>option</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Ignore SIGCHLD to prevent zombie processes */</span>
</span></span><span class=line><span class=cl>    <span class=nf>signal</span><span class=p>(</span><span class=n>SIGCHLD</span><span class=p>,</span> <span class=n>SIG_IGN</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sk</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>PF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=n>IPPROTO_TCP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Allow the port reuse immediately after the server is terminated. */</span>
</span></span><span class=line><span class=cl>    <span class=nf>setsockopt</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>SO_REUSEADDR</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>option</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>option</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>sk</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Can&#39;t create socket&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>port</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>addr</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>addr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>.</span><span class=n>s_addr</span> <span class=o>=</span> <span class=nf>htonl</span><span class=p>(</span><span class=n>INADDR_ANY</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Binding to port %d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=nf>bind</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>addr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>addr</span><span class=p>)))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Can&#39;t bind socket&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=nf>listen</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=mi>16</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Can&#39;t put sock to listen&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Waiting for connections...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>ask</span><span class=p>,</span> <span class=n>pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>ask</span> <span class=o>=</span> <span class=nf>accept</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ask</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Can&#39;t accept new conn&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>pid</span> <span class=o>=</span> <span class=nf>fork</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;Can&#39;t fork&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>pid</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>close</span><span class=p>(</span><span class=n>ask</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>close</span><span class=p>(</span><span class=n>sk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>serve_new_conn</span><span class=p>(</span><span class=n>ask</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Usage: %s &lt;port&gt;</span><span class=se>\n</span><span class=s>Example: %s 8080</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>main_srv</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><p>tcp-client.c:</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>c</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;arpa/inet.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/time.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>main_cl</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sk</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>ret</span><span class=p>,</span> <span class=n>val</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>rval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>timeval</span> <span class=n>t0</span><span class=p>,</span> <span class=n>t1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>sockaddr_in</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>sk</span> <span class=o>=</span> <span class=nf>socket</span><span class=p>(</span><span class=n>PF_INET</span><span class=p>,</span> <span class=n>SOCK_STREAM</span><span class=p>,</span> <span class=n>IPPROTO_TCP</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>sk</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>port</span> <span class=o>=</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>addr</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>addr</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>addr</span><span class=p>.</span><span class=n>sin_family</span> <span class=o>=</span> <span class=n>AF_INET</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=nf>inet_aton</span><span class=p>(</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=o>&amp;</span><span class=n>addr</span><span class=p>.</span><span class=n>sin_addr</span><span class=p>))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>addr</span><span class=p>.</span><span class=n>sin_port</span> <span class=o>=</span> <span class=nf>htons</span><span class=p>(</span><span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=nf>connect</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=p>(</span><span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>addr</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>addr</span><span class=p>)))</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Connected to %s:%d ...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>port</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>gettimeofday</span><span class=p>(</span><span class=o>&amp;</span><span class=n>t0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=nf>read</span><span class=p>(</span><span class=n>sk</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>rval</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>rval</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>sleep</span><span class=p>(</span><span class=mf>0.0001</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>gettimeofday</span><span class=p>(</span><span class=o>&amp;</span><span class=n>t1</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;%f ms</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=p>(</span><span class=kt>float</span><span class=p>)((</span><span class=n>t1</span><span class=p>.</span><span class=n>tv_sec</span> <span class=o>-</span> <span class=n>t0</span><span class=p>.</span><span class=n>tv_sec</span><span class=p>)</span> <span class=o>*</span> <span class=mf>1000.0</span> <span class=o>+</span> <span class=p>(</span><span class=n>t1</span><span class=p>.</span><span class=n>tv_usec</span> <span class=o>-</span> <span class=n>t0</span><span class=p>.</span><span class=n>tv_usec</span><span class=p>)</span> <span class=o>/</span> <span class=mf>1000.0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>argc</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Usage: %s &lt;address&gt; &lt;port&gt;</span><span class=se>\n</span><span class=s>Example: %s 127.0.0.1 8080</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>main_cl</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h2 id=build-the-images>Build the images
<a href=#build-the-images class=hanchor arialabel=Anchor></a></h2><p>Create Dockerfiles for both the client and server:</p><p>tests/tcp-server.Dockerfile:</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>Dockerfile</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=s>ubuntu:latest</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> tcp-server /usr/local/bin/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;/usr/local/bin/tcp-server&#34;</span><span class=p>,</span> <span class=s2>&#34;8080&#34;</span><span class=p>]</span></span></span></code></pre></div></div><p>tests/tcp-client.Dockerfile:</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>Dockerfile</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=w> </span><span class=s>ubuntu:latest</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> tcp-client /usr/local/bin/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;/usr/local/bin/tcp-client&#34;</span><span class=p>]</span></span></span></code></pre></div></div><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>podman build -t tcp-server-e2e -f tests/tcp-server.Dockerfile .
</span></span><span class=line><span class=cl>podman build -t tcp-client-e2e -f tests/tcp-client.Dockerfile .</span></span></code></pre></div></div><h2 id=start-the-coordinator-server>Start the coordinator server
<a href=#start-the-coordinator-server class=hanchor arialabel=Anchor></a></h2><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>criu-coordinator server</span></span></code></pre></div></div><p>This runs the central server that will coordinate all clients.</p><hr><h2 id=create-a-network-for-containers>Create a network for containers
<a href=#create-a-network-for-containers class=hanchor arialabel=Anchor></a></h2><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>podman network create --subnet 192.168.90.0/24 criu-e2e-network</span></span></code></pre></div></div><p>This ensures both client and server containers can communicate.</p><hr><h2 id=run-tcp-client-and-server-containers>Run TCP client and server containers
<a href=#run-tcp-client-and-server-containers class=hanchor arialabel=Anchor></a></h2><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>podman run -dt --name tcp-server-e2e --network criu-e2e-network --ip 192.168.90.10 tcp-server-e2e
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>podman run -dt --name tcp-client-e2e --network criu-e2e-network --ip 192.168.90.20 tcp-client-e2e 192.168.90.10 <span class=m>8080</span></span></span></code></pre></div></div><p>Now we have two containers:</p><ul><li>A <strong>TCP server</strong> listening on port 8080.</li><li>A <strong>TCP client</strong> connecting to it.</li></ul><p>You can check logs with:</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>podman logs -f tcp-client-e2e tcp-server-e2e</span></span></code></pre></div></div><hr><h2 id=configure-criu-coordinator>Configure criu-coordinator
<a href=#configure-criu-coordinator class=hanchor arialabel=Anchor></a></h2><p>Create a configuration file for criu-coordinator that defines the dependencies between the two containers. Save it as <code>/etc/criu/criu-coordinator.json</code>.</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>CLIENT_ID</span><span class=o>=</span><span class=k>$(</span>podman inspect --format <span class=o>{{</span>.Id<span class=o>}}</span> tcp-client-e2e<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nv>SERVER_ID</span><span class=o>=</span><span class=k>$(</span>podman inspect --format <span class=o>{{</span>.Id<span class=o>}}</span> tcp-server-e2e<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir -p /etc/criu
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; /etc/criu/criu-coordinator.json
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>    &#34;address&#34;: &#34;127.0.0.1&#34;,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;port&#34;: 8080,
</span></span></span><span class=line><span class=cl><span class=s>    &#34;dependencies&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>        &#34;${CLIENT_ID}&#34;: [&#34;${SERVER_ID}&#34;],
</span></span></span><span class=line><span class=cl><span class=s>        &#34;${SERVER_ID}&#34;: [&#34;${CLIENT_ID}&#34;]
</span></span></span><span class=line><span class=cl><span class=s>    }
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span></span></span></code></pre></div></div><p>This file tells the coordinator how containers depend on each other.</p><p>Also configure CRIU to use criu-coordinator as its action script:</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>COORDINATOR_PATH</span><span class=o>=</span><span class=k>$(</span>realpath target/debug/criu-coordinator<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;action-script=</span><span class=si>${</span><span class=nv>COORDINATOR_PATH</span><span class=si>}</span><span class=s2>&#34;</span> &gt; /etc/criu/default.conf</span></span></code></pre></div></div><hr><h2 id=checkpoint-both-containers>Checkpoint both containers
<a href=#checkpoint-both-containers class=hanchor arialabel=Anchor></a></h2><p>Here we checkpoint both containers using Podman, ensuring to include the <code>--tcp-established</code> flag to preserve the TCP connection state.
We run each command on a separate terminal.</p><p>Terminal 1 (for the client):</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>podman container checkpoint --tcp-established -e /tmp/server.tar.gz tcp-server-e2e</span></span></code></pre></div></div><p>Terminal 2 (for the server):</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>podman container checkpoint --tcp-established -e /tmp/client.tar.gz tcp-client-e2e</span></span></code></pre></div></div><p>Both containers should be checkpointed while keeping their TCP state.</p><hr><h2 id=clean-up>Clean up
<a href=#clean-up class=hanchor arialabel=Anchor></a></h2><p>We can now remove the stopped containers:</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>podman ps -a
</span></span><span class=line><span class=cl>podman rm --all</span></span></code></pre></div></div><hr><h2 id=restore-both-containers>Restore both containers
<a href=#restore-both-containers class=hanchor arialabel=Anchor></a></h2><p>Run each command on a separate terminal.</p><p>Terminal 1 (for the server):</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>podman container restore --tcp-established -i /tmp/server.tar.gz</span></span></code></pre></div></div><p>Terminal 2 (for the client):</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>podman container restore --tcp-established -i /tmp/client.tar.gz</span></span></code></pre></div></div><p>The containers should be restored and reconnect successfully. You can check the logs again to see the client receiving data from the server:</p><div class=highlight-wrapper><div class=highlight-toolbar><span class=item><span class=label>Lang:</span>
<span class=name>bash</span>
</span><button class="item right outline brighter hide js-btn-copy-code">Copy</button></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>podman logs -f tcp-client-e2e tcp-server-e2e</span></span></code></pre></div></div><p>That’s it! You have successfully checkpointed and restored a simple distributed application using criu-coordinator and Podman. Thank you for reading!</p><hr><h2 id=resources>Resources
<a href=#resources class=hanchor arialabel=Anchor></a></h2><ul><li><a href=https://criu.org>CRIU Documentation</a></li><li><a href=https://podman.io>Podman Documentation</a></li><li><a href=https://linuxcontainers.org/lxc/documentation/>Linux Containers (LXC) Documentation</a></li><li>GitHub Repository: <a href=https://github.com/checkpoint-restore/criu-coordinator>checkpoint-restore/criu-coordinator</a></li><li>GSoC Final Report: <a href=https://github.com/behouba/gsoc-2025>behouba/gsoc-2025</a></li><li>Demo Video: <a href="http://www.youtube.com/watch?v=bLzeN9JL6sk">YouTube</a></li></ul><hr></div><footer class=post-footer><div class=gitinfo><p>Article last updated on 2025-09-20 16:49:20 -0500 -0500 by commit
<code><a href=https://github.com/behouba/behouba.github.io/-/commit/46e103f0fbce032d287d27d07575f6d8cdfaa548>#46e103f |
posts: add article for coordinated checkpointing with criu-coordinator and podman</a></code></p></div><div class=pagination><div class=pagination-title><span class=pagination-title-h>Read other posts</span><hr></div><div class="buttons fill"><a href=https://behouba.github.io/2023/10/memory-forensics-analysis-of-container-checkpoints-with-checkpointctl/ class=button><span class=icon>&lArr;</span>
<span class=label>Memory Forensics analysis of container checkpoints with checkpointctl</span></a></div></div></footer></article></main><footer class=site-footer><p class=buildinfo><time datetime="2025-09-20 21:51:18 UTC">Site built on: 2025-09-20 21:51:18 UTC</time></p><div class=copyright><p><span>&nbsp;</span><a href=https://github.com/behouba>behouba</a></p><nav class=navbar><ul class=navbar__list><li><a href=https://behouba.github.io/posts/index.xml>RSS</a></li><li><a href=https://behouba.github.io/sitemap.xml>Sitemap</a></li><li><a href=https://github.com/behouba/behouba.github.io>Source</a></li></ul></nav></div><p class=themeinfo>Powered by <a href=https://gohugo.io>Hugo</a>, using theme <a href=https://manid2.github.io/hugo-xterm/>Hugo Xterm</a>.</p></footer></div></div><script type=text/javascript src=https://behouba.github.io/bundle.min.js></script></body></html>